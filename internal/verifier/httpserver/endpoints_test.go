package httpserver

import (
	"encoding/base64"
	"encoding/json"
	"fmt"
	"log"
	"net/url"
	"strings"
	"testing"
	"vc/pkg/openid4vp"
)

var walletResponse1BodyMedJWE string = "cmVzcG9uc2U9ZXlKaGJHY2lPaUpGUTBSSUxVVlRJaXdpWlc1aklqb2lRVEkxTmtkRFRTSXNJbXRwWkNJNklqRmlZVFkwTWpsaExUTTROR010TkRJNU1TMDVaakJoTFRWbU1tTTBPV1UwTmpZNE15SXNJbVZ3YXlJNmV5SjRJam9pV2kxdmVrTnZWSGRuVkdkTU4yOXNielUxTFRjNVJYRmllbG8xVVVWR05sRnBYMEZmZVRSemNYbGFTU0lzSW1OeWRpSTZJbEF0TWpVMklpd2lhM1I1SWpvaVJVTWlMQ0o1SWpvaVpUVTJVREpuUVZrNFVFSkdkR04yTkcxSmFqaFVhWE5LUW5OR2F6VnJiMlJNZEdndGRGWlZVRzg0VFNKOWZRLi5VNVQ4Z2xtdWN1bElBZUFKLm5XVWVPM1JqMlNzNFJxdll0b0dKZkNIOFRWTkZ4bVQ5RWw4ZHAwSEpieDNJeXI0MHlNNjdwaGU5NmFRSUVGVC1kdUJjb0NaZkZYUHd4QjBVR2xPeUsyZGdEQkh4SGNyUDhvQm1yZk1LQXVlTWJqak9UZ29KR2Rib1Fod3VxaFp3Yy1iSnFNNU53QzZwcG5EQS1uYy03VkdRLWFrakxxU1ZVajl2c29ZbzdSMWZUclR5Rzc1cmNvRlljUUh3bXQwcVVhMkNabzVPY2V0M1FMTVJWWVdKNFNuWTUwcXNGUnVhd2tSZVRiVmt6N2xVcEhjdEEzeWE5N1dsU0p5ZXl0VXBReVVid3VQUUtSbG10N0N1eHNXN1VoOWxvb0tzSk0tZ28tVDkyQ01KUG9ybFpNM2tEdTRCUVpTMWZ2MjVhMGhaaGNCY3lDeVBQVkNyaXpvYlpYeEk2ZzBicEE3TGJrZHNncTFaNzlYWXBTdG5wN01ZQ1pwazNkMkNSVWE1QUM3OVFBZGxIZ0wxN1BrMlh4TlBUdHpsVFBBdThLTG5pR2V4cXBNenJiczJhcWRHdkRwWEo0UXZ3NzhvLXljMVZjQWxPZmV0WVpSN1NLMDNVeXVIVmlWQ2oxczlUdzl6OVg1blIwNWtVci13cmpTZm9DOWRnOUpqd25VV1d5MHVKTDNhamVfaWFzSjZxVElQVm50bWI2NzN2dGxiU3NSVGh2eTNJSWFhTkFaZHNiSlR0NXdsV0JNdkZUZERKS2twemhoTjB4cHJhX0VpdkpyZDZtYUh6aXdOU0pBZW9oVDJaTWhCWHJCU0VjUnR5UDdPM2xPdTdOeHpsSkdHc0dlTTBadlQyR0VWU3FCekJ3NU4xbmprc3FVVjd6clBzUTJLS3AzZFlvdkRqTTJ6Zmk4NVVFNV8wUE5odjFVMmpESUc5dU1GVmpLRGxHSzUtd2lXcDVBTXhlUzBXWG1EYlROMEFNLW5UTk52ZmVjUDRFcEpqU18zeVNtbDlFeUg1M1M5czFpbWhhaVhGSFY4ZTBUVlJkTklwLXZkd0owOFV2d045UkZaVk9mUTVZckdIaGgzMVhvVThDemlrcXQ1ZXZzaFkwMnJmMWNsdGtpbFJnSUY4dzhzVm1YRkRxWm1HY3NMMXBQY3ZNRVZRQy1CWUVaWk0wTko0RHE4bGpfTEluNlpQV2JKUFc1T3MydEFUbm8yQWJPNTlOWUdGYVd2ay1Yc1lWZFRCUERmNWNKeDQyTXhna3MtbHVRZWgyTGJiMnZRWUIydGszQVNiOURkVXdHYUZ3Snh2d2t6dklJWVpDRzRnQ2xtWWI1M0NtT052dDhkNjlOS0YzMl92MWNZNGptVWlZdEQ2Y1B3N0hHNHRqdDNaUjIybjN0bW9MSDBBS2hmRHZSdk9PS3NCaWl3bi1wekhRU05aLVgzQkhuLUROZjJ5WkpGTUlscERNeUxjaTY2M2JUcGdXZGsxV0JKSzRia2FwWFRCQmZXS1pPMGlId0x4LURram1TZ1JGcVlUQWd5Z2pZVFFITDh2aWtFYkMtUm5IeXc4Z1llVVI0MkpxdWthcXI3NmVzMmxhbVljdjkzQV9TM1RQVVh0UFZHczNQalozVEQ4T1VXSndubTVIak05N3Q3WU9ZQ0xiY2FLWnZjU3lXSzlSZ1lDTGUxMWRsUVU5ZE9GcHZidDdnQzUtSEc5UlZDY091ekMtQXVZWWV6QkZKVkdFOVhmWXllVUhhNkJLRm94NmFyMzgtR2UzWGM1cmJxZG1NYWNUWjRPNWUtdHdGWmRSNUtpb1BhMWc5dzROTW1yWDdXYm54dGhqc093SENwT3JGQTkwVkdMc2hhaHJ3Y3FrLTV1UVJZYjRtYk1mLTZOdlJvbHpHVEQ1cUZmTWJDRTZTTWhxQjM4M1V5U05JanJPTTdsVjBIakJzQ2hEOGhfdldBeU55Y0x6Tml0WHdLMnlXUTNnNjhKaGVBV3cxODFzb2s4YnBsbXhxVV9DRHM1bUEwRjJoOWtwck5wSnFuZWR2S0xaNEJXU1Q0M3QtWWVFS1dNV3JlODNWWVJobHFiOGFheFh1OHhseVNUOUZEUXp0ZDA3SGNxVkVKYklBdEhCYjRGTkJmX3NhTXR3dnRjNjUtLXVUT3EzSm9CN1NWMlJJU1l1NlNGdThvUXQ2aHl6YlJXbjFPdFhsZ25fdHJ6dU5qR2dwdjdsVkFZdThKQWhUSTBpTmpZekV5bXFCVlN5ZDE5RS1uR3lqNUtUclJEcG4wNnE1Mk9LMHJVRzd1ZFVtMndzLS1KNmFMcXlDZWJIQ09XWlQ3Q2JNYkJvY052TXl4ekRqLUJiUWRjQ1Uzbmo1UEdlNkVKNzVvREwyT0xMTlg3Tks1MndiN2JESzA5OE1aM1VsdVZ1TkpOX3I1YXN4eXZ6VDkxbWwzOWo2NzZqZmtFUGdhOXZmUHNyWDZRb3YwdWxmeVJnOW1CcF84US1JYUFjamRUSE1EV3hDeEdvcDVNX1pyejF5YjFTMDRHbnNpcW51RVgwM0dibzkwOWJJYVQzWkpSUmZUZVFURVc5V2hScC1jTGVEQVJlN05TVEVYQUR3MnlXX3VZOGMyNXViUE1EdXI2cTU2S3FHZEN3SnE0YUpNY3o4dGc4S1B1NG84UEx0MktUdVhmTHBBQm9DVVEyOUdMQW5tUHRCMGJyRTJ6S3VyanFMM1h6RGxBelg0eHE2SV9CODhKV3VJNlU4ZE5mcFdrZ2lwVm5UeHFNb2Y3QkZlUVhxcl9pOTJnSFNicWtNNm5WUnFDT3hCdmJVOEdRZDhsVUxWZmx0d1ZtODRxeTZmVGJVTF96a2Z4V3NsTHhvc21XcDJ0M0F3dzRqaS1QSHRnWUVYekFhcUtRYnNlQnAtSUp2TWdmM1NLemVKZEY2c1JJbE9ybHZ4c2hvaGRrWXROQjVseEVvTnc0YkQ1NDJvejJJNDVwcUdPb3J2WEJHTkdPZ1NCclJuZUlwbTZEd3kwVk43Nm5DcnZLcWI3bzlfUzRJUkRmbURVY3hfZi1hWXNyQXQ4Tnp4ZGhzdS1XbnZWTmpmSFIzQnBvQzVBNUtma1I5cTk1Z1gwWGNxcmd4V1Q4QklBRWE5blhDUE5Nc2ZvLW95a2ZZV2RVR2dNXy1SeXpPUl82M1lzWjVON1FqNkZzZGd4eWpUY1U2NHhvTkxsVXBvNTRFdDJhR1Z6Y1RhaWU4T2dIcUR4ZU9XenpZcDZBN1JveVZsOWEyOWxJTlJfcDZhdGtYaVp0bDEtbmN4dWFNUXQtWkVIdGwyNzF6b09tcHpQUk1CM1JnLXc3WWwteXIxYXJmLVhhSXpOZFo0Ny11YnEwelZRcTQ2dXBZRDJTaVZRWDNleVlhdGh1bFZtN1E2d0pxTHZvY3F1Y1NEdkI2V2dnVnN1ejV5NTdDNXlSOVVlak5iclJIdl9IcWVpN0xvdFFoa1VabjlPZEtqbzNoakpjRTJjVW0zQ3RObHNWRGhZbFZqdUpVTlhQeFdBekxrdUZybEIzbGpXWmo3RWpfamNvVEx3ZTM4Ykt2aHNzbFdJLVcwUTNhNXpRNmJBZzEydVBuRGdNbndyLVJsZVJOaUVMOWE3bHh3clV4UVdWLTI4aEVxcS1IanZWX1pQcEFCUEk5WWlQRVNpWU5VSHl2WEloamxVSDV5bk90dV9XdWZCN1VFX1JvWi1qQ3ZlN3FTSHBXUmFwNk1tVjFqVnJRZ21DeWhLTUROYjIwSEswQ0Q1WkY4eG9UY3RaeEJlNlVSaFh4MWZCRkN6MGZINnVNdHJMUzUzbVlTOENyZXMtREE5czI1OTdNODB4YnJqZDJMZ0FrbDNHQTI0UGNmdmJoQk9peVU2WUJ0X1BkMU9PX0h6bWc1N1djUTBxZmR5NWxuUV9lcWJoRVNNSC1tQ1BPSE5zdzJSbmNZc1lPckRDMjgwSGdLeFVTcWFBV3EwNDZ2bXZzbEtjUTJCekZvaFRHRzRXV01SNEkySGxoeUJWRE93b1VzX2dyTWtWc3J1U3MzQnJjVDhDa2tEWTgycnlKQlU0NnpVdTJfS0ZrMFlUbUJpalFyNHhBQ3lWZXV4NDJUazNqSDk4d1d5ajN6cnIxbVNYMloxVW1CQnhpREV5OFI5aUlRUU1mOFNucWtfOTBsVXg1UXotN0ZGTTFmNDFhUGRoeS1oaW5TRjcta3hIVmpRU2RnbUdBbTh0STdGQTlNcm03YmYtRXBCOE45V0dRX0xPQnBSS2pHbEptZGZFSjBpNllFYWlJN2x1VGlDdThLVlN3dmswY0JiV2ZKUkIteXBLZ2FvdGFVYUx2QmhETWpSQW1zMU52cTVfUHRzdDJqenVibFdocks0R1NWTy0yOGJKaDM4QnNfMUd2ek5Ydlh2Wlh5aFNMeElHRXFPUlFEcnZaXzhxZkNoeFBnTEpJZHdlVU9QRU44NGdjLUY2VGkzUUN2TWxGYUhyb2RETVlDXzNjRE52SG42em5XeHdrOWhTSklrZGlkOWtBU05aVGtlOG9haHhIMHRSTXNBTmFvZnZSQTNiNVhlUHJOVVZ3QzM0MEtZX3VQVjJxQVJJVGN0eTFNQjZnTzJSelBlaEEtM0gzOU9TNDNudjdLSmxWbk03NmJxWXF2bVQ2dElxRGplWndMdllIR1dnTUdGaGVDYW1KcHVCVVE1RXBKbFdfNnRlVURBaEd3N29BSzhueDBOVERJbUdTNUNVbkwtTnZJRFk5ZFNuc3R5M19TbnNJeUNQMVlmdWs4MV9zM1B3TFZhSHZZQWtBTjZoS0tndGhsMTJ5bGRWcWJZLV9yZ1VUbHNDNC1EUTEzd0xDQmNTUUU5YjQtSGM4Q1dETWYtaUY4bFkzb2ZRVFZDVk0tanFQYWU5aFNJdFl6bzV6cXRxVFUyLVQ4Vm1qYjFkSWtCWFAwS3RWRXN3OUI1d0doTXMtcWd4NWhWQmJrZnRCY3lDd1lmNWg4T0hwSG1UQ0p6MFdyNUNjdFUyc2ZOTGFSTV93N0Z0Tm1jYWdIMjlMR3NkanRUOF9wLWR5N01YdFFVdTNHTjZiU2JyWmcwZkduVHpzbVZzVG44Ulc4SmlHd3lvdUJ1ZEtKbzFrX0tkdjhpTkNHc05FaVp5dFlEMkp5Y2JNdENCM3hURUpBbDVzZU9TY1htRWxQUHlCRkljbkd2ZUdWclVRZVZ3Q1VlTmQ0MDF2eFNvWmdUbzM5YzN0U2s1eV92eEg1ZXRPT2w1STRxdE02emhSV213aXlYYUVEY19wR2RNcnUyRTYtdXU5Tk5pV3J1dndtNTlXQ0pkdVdYWjA2bXA2RXRnTE53NjNhemZxQnkxajBJRXlQTTU3ZmlSaVJSdmJXSGVvVkFSYW95OEx2WW51dm1tb2dsZHliNDNlZmN1Z2M0UVZFamVRQnMxdjBVZGxUVldlZ2lSTWdHaC1RSkktcDNWa3h6YUU1WGQ1aHZrQ01IQnBsNEUybzVyWnVqSzdUWnJMVXRnaG1oN2tZMjNGVlNSZHE4OGJKQ3VONGtISnpaYmN6eTZlTGFTeDZHbld2b2RQdDhGZzZLRjBrb1NBWGxYeDh0LXMxdENSNl9Eckp3SV84cUNWdG15Uk5qMHc5V1NpNFc0LVVua1ZmOFMtYVZ2S1N4U3FWMFc3YkpSbmxsWjNaR09xSkdGMTJtWGpZSFpIcnFXN1A5cXpuSU5YXzN6NHVPbmNBTkRWZjNhTDVOd0tZUjhUNk1ranFjX0JFdVlmck5veV9iOVJJT3pva1BUNmpZcVNrbm5lcFN3N2RWcHZvRm5jdzZ1bkFCcDFhOTVKemdpQ3YtZnM2ekM4R1ZXdzlFdnV0RmY5NWZkdWJXb0dmTDRrVy1RWFFkT0pqNEhYT3JJWldKdnYzUC1JZk5rNFFrRHktTGkyRTZidFJ4OENEa203X0gyRW5EellCSFNOb0xBWVZtcjJUbVRIUFJ4N213Z05tZmhUVk5JUDRZMDAtV2RoUkxKYzVSaDNDNjVqemducDVGLU0zWnV6d2cwM1VmMjBSOU1GZ19VOTN5ZWRqeG1aUlFwSkw1TzFMQkpIZ2h1U000clhpajFFMzJkN19TZHVKV1puWUtubFJXa1dYR214d01ZdHdiLTdsM19rWjNRYXFOaWZwUmhjYk55UHBoREt2NFM3Ny1zVm1lVWt3WmdxZXpJZmhzWEkxYW9IMVhIbnZNUE00TDlTSjNEMy1uWmNwS2JGeVl1aWxjc3k4Z3JWbjJNM1ZfRnpXckxrTDBqNW5XUUFoemhqZlR3Z0N2ZzlRU2RwUThfWUJSejlqdGh4bWNrcHFZc1p5bWk3Q2QybWs5c3lXbnpQTWZDRFVBUEZOMXFjZ2F3Zkp5X2ZheVF3WHhwemtuTG40N3BpaV9IVUllSU44TGx4c2ZEdHctb25jTVhLQXlDN1VoZV80TWs2ak1KS2Fhbzh4RE5fT0RrdWN1SDlxQTNrYXFKemc2dnFmcFVyc0lrQllVUDU4bko4MFhzWWJwN2M3a1Y2YUxBWXVoMnZRcDFwTnlfdGxzX29jQTBPMUNHaTZoOFhsRkxOQjBYUDNRcEhjZmZXbW9hRnpISC1vRHdzMk9hUFVaUHU5dUNPM0lQV1VSQktTbFdlbnBZaDBTV2stZERFeGE5emVtTVNsYVhHQWZ3cnlsWkJTUWNwdS1xRGdsM292aTgyMGdteTdzaGdnMEs5Ty16c1hEMkhFeFBRTVp2cmZQNW44UjFJaGdvUXVEclI1d3hjazcxd0FxSFhIeHI4Nk9ZdFdmek9seVFEOHVyRGdmdlpKUDVyS2laeHJnOFhKbDNQOWNYVVpxS0h6QVVscTN3RWROdmJFdHZBa1ZxQzVUWHpNUFlqY2JxQ2pfREJ1MDVXZWR2VnJrYjh3SVg3VVQxMExhbUFxZFpGZnQtYmR6c2NDX0VFaU5zQnF5eW9qZzdRY1FWU210Unhtd3BsUTJLajRUeFpEaHRxM2xUR2RENXNwWTFwdmRoZDZxVlR4YS1lZGVJWjJkU2VHMHF4NXh2VGZFVE13UkpjYUdmcm5ULWowdGF0Q2s4OFpDbDdSd0hIQTU0YUpkQ0dKaHZITGFmTDlxYWEtN1Y0YjU2aGQ2Y0VXSXQxb2NxX2hlTFBZZ0FoeGNRdHcwNFZjSU1rUWJ4U05hUjRYai1YdDBQUlo1SEtvWTg5VkV0U0doQy1NbkRzaW9uc2Vyc2VPYmlySl9QMFF3bTdIRnpUd0NheHAzTmU5VXd6R2NTMERlZlItU1ItVmtGc3R1SXhlWmdseGdUdVhwWHpnTkNIT0RlT0p1dFQybENnZ1h3aThuRHRmUXV2VFhoVnp2RHhDdjlOakplZkoydURLV0pueEpyRmZoWC1QTEp2b1dzci1vdzJsZUlQUUFsS000bEdpZWZDODAxQnVsQVBJQjFhYzlFSEJJazl3X3JEcjZTMkpWcjNIT3cyT2YzcG9IZ015TUM1dWpKUEFIb25Pb0xWZlJjQzhtVzZDc3NaaW9IYncxX09IeVpaclB5bE9oc0k4NVNCdWpod1p2eHlqWHlpaV9kTnhDM3kySGNZRHhKaFozOHdsNkFFTW83aFR2RGJ0Q0dxcGt3R18xUXNoaHRTUFJEYlFWWE80c08xenVQellLa1cwZ09DdXQ5M3VaUmR2YWRNWUpwOXJEZEdiZG5jUG1vamlTQW9oUENQekpRZkxpTEw3MHRxQ3J1ekhBNzZhRm11ekRJaEhNRjRVOVAwSnNrOEZKTmd5NDJUc1N6TGh4LWJ1cXkwVi0zMlY5Q1JiaU5PYmZ4Vm1SMUUxZ0hHN2w3Vk8yV1FwaTNSeWlVQjFiWTctcVYzODA4a3ZQN2RyNmxiNFNtZHlnNFp4cl9pRU8xOUVkQkNnZ3lSY1AtWUlNdXJrb2Z4bEppVWRUbTdIUGNxVVlWaUNBa19HZE5iZEhJdUkzTzNJSm9iSU5EZ0RwNFpSUVlkVlJYVXI2NnVsTEVQS3N3WTJjbUtUR204YWV2T0VaQ2tBbWFMTmh1Rnc2bjJ2Y21lTW1HNWdSVG0tcDFHRWg0X1BKSVlzZE1fMVdrNlF0alBwUC1UeDRfa1pfYWxQMEJHTzBEbmJSV2VEeW4tVy1XTng3c2xaeGw0LWRRaThUMUJQQUpySmZabF9lWU9aenV0LTFaQjRnS1hYWUxGNXFsNnB3ZGREbFk0ZDFEaGpzNzlGREp2WjhEa255MVlLQlhPV3ppV0FDNzduWmZaYTBOWFhLbUd2aEg5ZVJQVDdidld6ZXBRc29felM3WVhFNnB1Q3ZSdW9iYXdENk1mUEdwWXhOQmRfVjhJVlRwQlUwWXVTWmV3aE4xWk1ES1dnZ3JGNHRsbGNXLU5PTDR5LThZd3Y0dHRBZEFEUWZUX1FsX05MVHZSZmxwc1BpN1JNV3ZlMDRoNUJqQ0ttYV90dk00dzZoRFBqa3gwVHlpeUpEbWRLZHdCUy1BZ21uUE4xMDVab1pjZGZMMG0wSkxKNDM1SDRPa1JsNkNmTlItc2ZMbzBTUk1CMkg1V1E4Vk1RZkdHdjRrTFo5clhzaHJ5em9JWnNJdE5Ucm1nYlVBRzNVOUZfT0txdDI3UkJiYi1rTVRXSzZvOWU1ald5cExBRkozYmloNmFmUW1TQUluTDNxeDdtcDNTWkk4N3NvNnRNbDY3UEtVNXk3cTBpYWF2VXV1NkkyY2ItTExNZkJ6aVdOZ29XRXZxTjVPRU9Ra0JiU01lWWVqTXdhWUswMmk1N3g2bmFBNzYtVUdRNWdfN2k0YU50NmpsRHllaHN0eXhwZFpLSzQzOUpYWWtjODIySVBEZFVTNGVKMUd0ZDJxa2lSaEdPWFZ0LXAtNXk0a245cGl5bVVTbVZVc2Y0MUZ1aGZuQTZxNjdfNkpXZml5cXktcENLNDNwNWxTcnF4M21jUVhNcjRQYi1Na0tGc2QxY3pXYmdXV1ZmU3B1Sm85d0M2ZExaY3oyWV8xTUpzWHFBSmpYb3V4TlNTRzFrN2RuMWlkOWlaM1lDNERWZEFkN2xwV1NlY2IxX2txcVN3OXBHSU80QUxoVFZCaEVKQ2pPT2Nmd3lhckprYzYxdzVkemM2cnZPck54TE54Zm9hWUhVcnZzXzVtYjdoeTdmMmFnTExDclVQSW52eWQ2RE1GY0FLb0NsUVplNjdKQUpZLThlOVdaRDRGTEhoV1MybXRrVGtJbGxUenpRNEgwZjNZZVU0MkR1dnRsV21COEhDcEppRTBiZUxlMWNlYldSVzZBMjlZWGIzb1RYZUdqbXFqU0ZTcHN4bDQwVW5ORnliZFc0bE5PMm5IX3VnZWNOcWJWWkFCRzZUSFo4RUtZMEV4dUxDd0c2ODVyRW5DWUZIQzFkODQxY040T1Y3Yjk3a2xiNUJjSUlaTXhYbEM4c201RENRTkpVc2ZMTjF6ZDVyT281VlFPZi1NZlRkVXBQRGdXRHREZWhCcUxSWkxpdXBmU0JTWTk3NjlUWWRlV0Q0RlZLaGk5MzNGUWtNcUY1LmNES0lJMmJ5U0dLMFZsOXFjZ0t4MGc="

var walletResponseBody2SomNogInteIsJWE = "dnBfdG9rZW49ZXlKaGJHY2lPaUpGVXpJMU5pSXNJbXRwWkNJNkltUmxabUYxYkhSZmMybG5ibWx1WjE5clpYbGZhV1FpTENKMGVYQWlPaUoyWXl0elpDMXFkM1FpTENKMlkzUnRJanBiSW1WNVNqSlpNMUZwVDJsS1JsTkZiRVJSTTBwc1drZFdkV1JIYkdoaVEwbHpTVzAxYUdKWFZXbFBhVXBHVTBWc1JFbHBkMmxhUjFaNldUTktjR05JVW5CaU1qUnBUMmxLVldGSGJIcEpSMng2U1VkR2RVbEZWa2xUVlUxbldrYzVhbVJYTVd4aWJsRm5ZVmhPZW1SWFZtdEpSMG8xU1VoU2IxcFRRak5hVjNoelNVZDBkV0l6WkhWSlJWWkpVMVZOWjFOWVRucGtWMVo1U1dsM2FWcEhiSHBqUjNob1pWTkpObGN6YzJsaVIwWjFXbmxKTmtsdFZuVk1WbFpVU1dsM2FXSnRSblJhVTBrMlNXdFdTVk5WVFdsTVEwcDVXbGMxYTFwWVNuQmliV05wVDI1emFXTXliSFJqUjNoc1NXcHdOMGx0ZUhaYU1qaHBUMjV6YVdSWVNuQkphbTlwWVVoU01HTklUVFpNZVRsNVdWaGpkVm95YkRCaFNGWnBaRmhPYkdOdFRuWmlibEpzWW01UmRWa3lPWFJNTWxKcVRrZFdNVXd6V21wTWVtczBUWHBLYVZscVVUVk9SMVpxV2tSck5FMXRUWHBaVjBVeFRtMVdhMDFYU1RGTlJGSnNUVEpGTkU5RVVtdE9SRnByVFdwTmRtRlhNV2hhTWxaNlRESldiMkZYVG1wWldFcHJURzVDZFZwNVNYTkpibFo1WVZOT2NHSnVVbXhhTTBwd1pFaHJhVTlwU25waFIwVjVUbFJaZEUxVVNUQlplbFp0V2xkRmVFNUVhR3RPVkZreFRXcGthVmxYUlROT2Vra3hUMVJyTUUxdFNUSmFWMVV4VFVSVmQxcFVXWHBPVjA1cVQwUmFhazFxV1RSYWJWRXdUV3BWTkU0eVVYZE5ha3BvVG1wc2FrNTVTWE5KYlVaelpFWTVNRnBZYURCSmFtOXBVbFZvU2xGNVFrUlpXRXByU1c0d2MwbHRTbWhaTW5SdVkyMDVNV0p0VW1aWk1qbHpZak5KYVU5cFNXcE5WRWw0VFVSa2FrbHBkMmxrUjFZMFpFWTVhbUl5ZUhaamFVazJTV2xPUjFKcldrZFNhMWxwWmxOM2FXTXpXbTVZTTFKc1lsaENjMWxZVW14amVVazJWek56YVdSWVNuQkphbTlwWVVoU01HTklUVFpNZVRsNVdWaGpkVm95YkRCaFNGWnBaRmhPYkdOdFRuWmlibEpzWW01UmRWa3lPWFJNTWxKcVRrZFdNVXd6V21wTWVtczBUWHBLYVZscVVUVk9SMVpxV2tSck5FMXRUWHBaVjBVeFRtMVdhMDFYU1RGTlJGSnNUVEpGTkU5RVVtdE9SRnByVFdwTmRtRlhNV2hhTWxaNlRESldiMkZYVGxWYVZ6RjNZa2RHTUZwVE5YcGtiV05wVEVOS01XTnRhMnBoVnpVd1dsZGtlV0ZZVWpWSmFtOXBZekpvYUUxcVZUSk1WMDAxVFVSbk5Wa3lTWGxaZW1ocFQwUlJNVmxVV1RWUFZHTTBXVEpOTlZsWFVtcE5iVkV4VFRKTk5FOUVTWGRPTWxaclRsZEZNVTlFV1hwUFZHeHBUMWRHYkZwSFZUUmFWRVpvVDFST2FscEVUWGRPVjBWcFRFTktkMk50T1hkYVdFb3dZVmRXZWtscWNEZEpiVGw1WVZkV2RXUkhSakJoVnpsMVNXcHZhVWxwZDJsWk1qbHpZak5LWm1NeVRtOWFWekZzU1dwdmFVbHBkMmxaTWpsMVpFaEthR016VVdsUGFVbHBabGd4WkdaWU1XUk1RMHBxWWtkR2NHSllUV2xQYkhRM1NXNUNhR1JIWjJsUGJITnBZekk1YW1GWFJuTllNMDVzV1ROV2VXRllValZZTTBKd1ltbEtaRXhEU210aFdFNTNZa2RHTlVscWNHSmxlVXB6V1ZjMWJrbHFiMmxhVnpSMFZsWk5hVXhEU25OWlYwcHNZa05KTmtsc1RuWlpNbXhvWWtOQ1ZGcFhUakZqYld3d1pWTkNUMlJYTVdsYVdFbHBURU5LYTFwWVRtcGpiV3gzWkVkc2RtSnBTVFpKYkZKdldsTkNlbUl5VG5CWlYzZG5ZekpXYW1SWVNuQmtTR3RuWW01V2RGbHRWbmxKUnpsdFNVaFNiMXBUUWtaVFJXeEVTVWRvZG1KSFVteGphVW81V0ZOM2FXTXlVV2xQYVVscFRFTktlbVJ0WkdaaFYxRnBUMmxLZW1JeVRuQlpWM2htWXpKV2FtUllTbkJrU0d4bVkwZHNkVWx1TUhObGVVcDNXVmhTYjBscWNHSkpiVTUyWWxoQ2JHUkhWblZrUmpsd1ltNU9NR0ZZVWpGa1IyeDJZbWxKYzBsdGJIVmpNMUp3WkVoV01HRlhPWFZZTWs1MlpGYzFNR051YTJsWVUzZHBXa2RzZW1OSGVHaGxVMGsyVnpOemFXSkhSblZhZVVrMlNXMVdkVXhXVmxSSmFYZHBZa2RHYVZwWGQybFBhVXBLWXpOT01WcFlTV2RSTWpreFltNVNlV1ZUU1hOSmJWSnNZekpPZVdGWVFqQmhWemwxU1dwdmFWWkhhR3hKUjJ4Nll6TldiR05wUW1waU0xWjFaRWhLTlVsSE9XMUpTRkp2V2xOQ1JsTkZiRVJKUjJoMllrZFNiR05wU2psWVUzZHBZekpSYVU5cFNXbE1RMHA2Wkcxa1ptRlhVV2xQYVVwd1l6Tk9NVnBZU21aWk1qa3hZbTVTZVdWVFNqbE1TSE5wWTBkR01HRkRTVFpYZVVwcVlqSXhkMXBZVW14aWJsSm1ZVmMxZW1SSGJEQmtXRkp3WWpJMGFVeERTbkJpYms0d1lWaFNNV1JIYkhaaWJEbHdXa05LWkV4RFNtdGhXRTUzWWtkR05VbHFjR0psZVVweldWYzFia2xxYjJsYVZ6UjBWbFpOYVV4RFNuTlpWMHBzWWtOSk5rbHJiSHBqTTFac1kybENTbUp1VGpCaFdGSXhaRWRzZG1KcFFrUmlNbEpzU1dsM2FWcEhWbnBaTTBwd1kwaFNjR0l5TkdsUGFVcFZZVWRWWjJGWVRucGtWMVo1U1Vkc2RXTXpVbkJrU0ZZd1lWYzVkVWxIVG5aYVIxVm5ZakpaWjJSSGFHeEpSVlpKVTFWTloyRkhPWE5hUjFaNVNXNHhaRXhEU25wYVEwazJTV2xKYzBsdVRqSmFNVGx3V2tOSk5rbHRiSHBqTTFac1kydzVjR0p1VGpCaFdGSXhaRWRzZG1Kc09XcGlNbEpzU1c0d2MyVjVTbmRaV0ZKdlNXcHdZa2x0VW5aWk0xWjBXbGMxTUZneWJHdEpiREJ6U1cxU2NHTXpRbk5aV0d0cFQyeDBOMGx0ZUdoaWJXTnBUMmxLYkdKcE1WWlZlVWx6U1cxNGFGbHRWbk5KYW05cFUxZFNiR0p1VW5CYWJXeHFXVmhTY0dJeU5HZFpNa1o1V2tOQ2RXUlhNV2xhV0VscFRFTkthMXBZVG1wamJXeDNaRWRzZG1KcFNUWkpiRkp2V2xOQ1NscEhWblZrUjJ4dFlWZE9hR1JIYkhaaWFVSnFXVmhLYTBsSE5URmlWMHBzWTJsQ2RscHBRakJoUjFWblVsVm9TbEY1UW05aU1uaHJXbGhKYVdaV01ITkpiazVyU1dwdmFVbHBkMmxqTTFwdVdESnNhMGxxYjJsaFYxSnNZbTVTY0ZwdGJHcFpXRkp3WWpJMVptSnVWblJaYlZaNVdESk9hR050VVdsbVUzZzNTVzVDYUdSSFoybFBiSE5wWTBkV2VXRlhPV3RZTWxaMVpFZHNNR0pIVm5SYVZ6VXdTV2wzYVZwWE5XdGhWelZ1V0RKU2FHUkhWV2xZVTNkcFdrZHNlbU5IZUdobFUwazJWek56YVdKSFJuVmFlVWsyU1cxV2RVeFdWbFJKYVhkcFlrZEdhVnBYZDJsUGFVcEdaVWhDY0dOdWEyZFNSMFl3V2xOSmMwbHRVbXhqTWs1NVlWaENNR0ZYT1hWSmFtOXBWa2RvYkVsSFVtaGtSMVZuV1ZjMWEwbElVbkJpVjFWbldsaG9kMkZZU214YVEwSXdZVWRzZWtsSFRubGFWMUpzWW01U2NGbFhkMmxtVmpCelNXNU9hMGxxYjJsSmFYZHBZek5hYmxneWJHdEphbTlwV2xob2QyRllTalZZTWxKb1pFZFZhV1pXTUhOSmJrNXFZVWRXZEZsV09URmpiWGRwVDJsSmFVeERTbnBaTW1oc1lsZEdabVJZU25OSk1teDFaRWRXYm1OdGJEQmxVMGsyU1dsSmMwbHRWalJrUjFaMVdraE5hVTlwU1dsTVEwcHNaVWhTYkdKdFVucEpNbXgxWkVkV2JtTnRiREJsVTBrMlNXbEtPU0pkZlEuZXlKZmMyUWlPbHNpTkdoMVpUTnVabkpFYVRoUk55MVBaM05sUlVadVNsWmtiM2w1V21nM04xaHVVSFkxU1ZWcGRtWnBXU0lzSWxJMGRIbENRbGhDUVhoYVluWnFUSE5wV2kwd2JGRjVOVzVHZGtkZmVsTk1kM0F4VmtNelVqTmthMUVpTENKYVN6Vm5SMmt0WW5OV1FYTnVNVXRqYlhCeVRsOWxSbDluZERGRmRsSTJaM015WWxKb01uRXllV0pOSWl3aVRWY3dRMmxZVTFoNGNVdzRhRVIzV0RscFVWSmFRM2gyU1hWSllrRnNZVlV6TFZCdVZYSTBVM294TUNJc0lqTmxibm8zVlRKeloycFJaalV3T0VFeWVIZDBNRkZsUmpjek0xVTRiVzVOTkVKWmJUbE1kbXR0UTJzaVhTd2lYM05rWDJGc1p5STZJbk5vWVMweU5UWWlMQ0pqYm1ZaU9uc2lhbmRySWpwN0ltTnlkaUk2SWxBdE1qVTJJaXdpYTNSNUlqb2lSVU1pTENKNElqb2lNRGxFTTFGTlExWTJWWFphZG5BNVF6UlpNekowUVVGWVYyVldZVkY2WjNCdVFYZGhaRzVtVmtab1NTSXNJbmtpT2lKSU5qSm9lRzlZUVdwVVQxVXlSR3RKTmtSdmJtcDVUVnBVTm5vM1Z6TndaVzV6WlVSVVlXSlhkVlp6SW4xOUxDSmxlSEFpT2pFM056VXhNelUzTVRnc0ltbHpjeUk2SW1oMGRIQnpPaTh2YzJGMGIzTmhMWFJsYzNRdE1TNXpkVzVsZEM1elpTSXNJbTVpWmlJNk1UYzBNelU1T1RjeE9Dd2lkbU4wSWpvaVJVaEpRME55WldSbGJuUnBZV3dpZlEudlJxeWJoX0UzbnZTMnp6VU5GZGNZN3djY21tck96RDdhOENFSFVudlBwaWFKWmNURF9DcXVKUWJiZnhDVnhnOHZBUDE5LTNnNkZqYXJhWWpVRUk4VlElN0VXeUpsU0dsamIyTldlSE0wVFVwclVHbEdXa0UzVFVKQklpd2ljM1ZpYW1WamRDSXNleUprWVhSbFgyOW1YMkpwY25Sb0lqb2lNVGs0Tmkwd05pMHhPU0lzSW1aaGJXbHNlVjl1WVcxbElqb2lWMmx1YzJ4bGRDSXNJbVp2Y21WdVlXMWxJam9pUzJGMFpTSjlYUSU3RVd5SlpUa2hWV0Zac1puQXphRW94YWxka1JFSXhaV1ZCSWl3aWMyOWphV0ZzWDNObFkzVnlhWFI1WDNCcGJpSXNJalUyTnpnek5Ea3dJbDAlN0VXeUkwU2xwV1JUbE1aa0ZaYWw4NGVrVk1iM05aYWpCQklpd2laRzlqZFcxbGJuUmZhV1FpTENJM09Ea3dNVEl6TkRVMk56ZzVNREV5TXpRMU5pSmQlN0VXeUoxVWpOMGFIbEtXVFZxZFhaR1NGTlliR3ByVUUxM0lpd2lZMjl0Y0dWMFpXNTBYMmx1YzNScGRIVjBhVzl1SWl4N0ltbHVjM1JwZEhWMGFXOXVYMk52ZFc1MGNua2lPaUpHVWlJc0ltbHVjM1JwZEhWMGFXOXVYMmxrSWpvaVEweEZTVk5USWl3aWFXNXpkR2wwZFhScGIyNWZibUZ0WlNJNklrZHliM1Z3WlNCRFlXbHpjMlVnWkdWeklFVERxWEREdEhSeklHRnpjMmx6ZEdWa0lHSjVJSFJvWlNCRFpXNTBjbVVnYjJZZ1JYVnliM0JsWVc0Z1lXNWtJRWx1ZEdWeWJtRjBhVzl1WVd3Z1RHbGhhWE52Ym5NZ1ptOXlJRk52WTJsaGJDQlRaV04xY21sMGVTSjlYUSU3RWV5SjBlWEFpT2lKcllpdHFkM1FpTENKaGJHY2lPaUpGVXpJMU5pSjkuZXlKdWIyNWpaU0k2SWtWTWFDMTVMVXBvV2pkeGVHWXljbEJyU0hveVQyTlZjMnhNV0habVZ6VnFNMXA1ZFU5eVUyTm1iVzhpTENKaGRXUWlPaUoyWXkxcGJuUmxjbTl3TFRNdWMzVnVaWFF1YzJVaUxDSnpaRjlvWVhOb0lqb2libVp4ZEhsTVJVUlhlbWRWUmxoV2RUZDVjblV0U25GU1MxSk1iazVPZG5jNWJVcFNNVlIwVmxCblRTSXNJbWxoZENJNk1UYzBORGd3TWpNek1IMC5DVXJjNUtlLVdLdks0a0pHZVdtUUdsSkJXSVJwTTRuYlNoS2x5TlJhZzVvY2Z4X1VCdHBDNmN2YS1LV2dOYnQyanlydUFUVVpwdldGVXJxd3NwQkZ3USZwcmVzZW50YXRpb25fc3VibWlzc2lvbj0lN0IlMjJpZCUyMiUzQSUyMmZjOTEyMzA3YTZiOTFhMDUlMjIlMkMlMjJkZWZpbml0aW9uX2lkJTIyJTNBJTIyU2F0b3NhRXVyb3BlYW5IZWFsdGhJbnN1cmFuY2VDYXJkJTIyJTJDJTIyZGVzY3JpcHRvcl9tYXAlMjIlM0ElNUIlN0IlMjJpZCUyMiUzQSUyMlNhdG9zYUVISUMlMjIlMkMlMjJmb3JtYXQlMjIlM0ElMjJ2YyUyQnNkLWp3dCUyMiUyQyUyMnBhdGglMjIlM0ElMjIlMjQlMjIlN0QlNUQlN0Qmc3RhdGU9NDMwOTQwOTgtOTQ5OC00ZDU1LWIwMjctNDI3NDdkNWIyMmMy"

func TestService_endpointCallback(t *testing.T) {
	fmt.Println("Start")
	//TODO: nedan kan i metoden toResponseBody läsa ut innehållet före det blir fel
	//responseBody, err := toResponseBody(walletResponseBody2SomNogInteIsJWE)
	//if err != nil {
	//	fmt.Println(err)
	//} else {
	//	fmt.Println("JWE=", responseBody.Response)
	//}

	ar, err := toAuthorizationResponseBody(walletResponseBody2SomNogInteIsJWE)
	if err != nil {
		fmt.Println(err)
	}

	fmt.Println("JWE=", ar)
}

func toAuthorizationResponseBody(encodedBody string) (*openid4vp.AuthorizationResponse, error) {
	padded := encodedBody + strings.Repeat("=", (4-len(encodedBody)%4)%4)

	decodedBytes, err := base64.StdEncoding.DecodeString(padded)
	if err != nil {
		return nil, fmt.Errorf("base64 decode failed: %w", err)
	}
	fmt.Println("### DECODED BYTES:", string(decodedBytes))

	values, err := url.ParseQuery(string(decodedBytes))
	if err != nil {
		return nil, fmt.Errorf("url parse failed: %w", err)
	}
	fmt.Println("### VALUES FROM PARSED QUERY:", values)

	var p openid4vp.AuthorizationResponse
	err = json.Unmarshal(decodedBytes, &p)
	if err != nil {
		log.Fatalf("Failed to unmarshal: %v", err)
	}
	return &p, nil

	//return &openid4vp.AuthorizationResponse{}, nil
}

func toResponseBody(encodedBody string) (*ResponseBody, error) {
	padded := encodedBody + strings.Repeat("=", (4-len(encodedBody)%4)%4)

	decodedBytes, err := base64.StdEncoding.DecodeString(padded)
	if err != nil {
		return nil, fmt.Errorf("base64 decode failed: %w", err)
	}

	values, err := url.ParseQuery(string(decodedBytes))
	if err != nil {
		return nil, fmt.Errorf("url parse failed: %w", err)
	}

	return &ResponseBody{
		Response: values.Get("response"),
	}, nil
}
